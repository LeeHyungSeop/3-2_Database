<!-- welfare center login 성공되면서 동시에 main page -->
<html>

<head>
    <title>Welfare Center's Main Page</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>    

<body>
    <h1>청년의 도움이 필요한 공고를 등록해주세요.</h1>
    <br>

    <form action="/process/wc_register" method="post">
        <table>
            <tr>
                <td><label>노인복지회관명</label></td>
                <td><input type="text" name="wcName" placeholder="필수 입력" required></td>
            </tr>
            <tr>
                <td><label>신청자 이름</label></td>
                <td><input type="text" name="olderName"  placeholder="필수 입력" required></td>
            </tr>
            <tr>
                <td><label>신청자 전화번호</label></td>
                <td><input type="text" name="olderPN" placeholder="필수 입력" required></td>
            </tr>
            <tr>
                <td><label>필요한 서비스</label></td>
                <td><input type="text" name="sDescribe" placeholder="ex: 온라인 예매, 짐 옮기기" required></td>
            </tr>            

        </table>
        <input type="submit" value="등록하기">
        
    </form>

    <hr>

    <h1>현재 게시된 공고를 확인할 수도 있어요.</h1>
    <div>
        <label>노인복지회관명</label>
        <input id="search_wcName" type="text" name="search_wcName" placeholder="필수 입력" required>
        <br>
        <button id="search_service_from_db">검색하기</button>
        <div id="show_service_from_db">
            <br>
            <!-- "서비스고유번호", "신청자 이름", "신청자 전화번호", "서비스 간략한 설명", "할당 여부", "처리 여부" column명을 갖는 table, 규격설정 -->
            <table id="show_table_columns" border="01">
                <tr>
                    <th>서비스고유번호</th>
                    <th>신청자 이름</th>
                    <th>신청자 전화번호</th>
                    <th>서비스 간략한 설명</th>
                    <th>할당 여부</th>
                    <th>처리 여부</th>
                </tr>
        </div>
    </div>
    
    <script>
        const search_btn = document.getElementById('search_service_from_db')
        search_btn.addEventListener('click', () => {
            searchDataFromDB()
        })

        const searchDataFromDB = () => {
            fetch('/process/search_service_from_db', {
                method: 'post',
                body: JSON.stringify({
                    wcName: document.getElementById('search_wcName').value
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then((res) => res.json())
            .then((res) => {
                // json type으로 parsing
                console.log("res.result : " + res.result)
                if(res.result == "failure"){
                    console.log('data를 받아오지 못했습니다.')
                    var show_table_columns = document.getElementById('show_table_columns')
                    show_table_columns.innerHTML = "<tr><th>서비스고유번호</th><th>신청자 이름</th><th>신청자 전화번호</th><th>서비스 간략한 설명</th><th>할당 여부</th><th>처리 여부</th></tr>"
                    document.getElementById('search_wcName').style.backgroundColor = "red"
                    setTimeout(() => {
                        document.getElementById('search_wcName').style.backgroundColor = "white"
                    }, 1000)
                    return;
                }
                // 받아온 data=rows(res)를 갖고, "show_service_from_db"에 table로 출력해줌
                else if(res.result == "success"){
                    console.log('data를 받아왔습니다.')
                    // rows는 string type이므로 array type으로 변환
                    const rows = JSON.parse(res.rows)
                    console.log("rows : " + rows)

                    // "show_table_columns" table에 규격에 맞게 받아온 rows를 출력
                    var show_table_columns = document.getElementById('show_table_columns')
                    // 받아온 rows를 table에 출력, 기존의 table 내용은 삭제, 각각의 row마다 "취소" button 삽입
                    show_table_columns.innerHTML = "<tr><th>서비스고유번호</th><th>신청자 이름</th><th>신청자 전화번호</th><th>서비스 간략한 설명</th><th>할당 여부</th><th>처리 여부</th></tr>"
                    for(let i = 0; i < rows.length; i++){
                        show_table_columns.innerHTML += 
                            "<tr><td>" + rows[i].sNum + 
                            "</td><td>" + rows[i].vName + 
                            "</td><td>" + rows[i].vPhoneNum + 
                            "</td><td>" + rows[i].sDescribe + 
                            "</td><td>" + rows[i].isAssign + 
                            "</td><td>" + rows[i].isFinish + 
                            "</td></tr>"
                    }
                    // 각각의 row 바로 오른쪽에 "취소" button 삽입
                    for(let i = 0; i < rows.length; i++){
                        show_table_columns.rows[i+1].insertCell(6)
                        show_table_columns.rows[i+1].cells[6].innerHTML = "<button id='cancel_btn'>취소</button>"
                    }
                    // "취소" button을 누르면 해당 row 삭제, DB에서 해당 service 삭제
                    for(let i = 0; i < rows.length; i++){
                        show_table_columns.rows[i+1].cells[6].addEventListener('click', () => {
                            console.log("취소 button을 눌렀습니다.")
                            console.log("취소할 service의 sNum : " + rows[i].sNum)
                            fetch('/process/cancel_service', {
                                method: 'post',
                                body: JSON.stringify({
                                    sNum: rows[i].sNum
                                }),
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            }).then((res) => res.json())
                            .then((res) => {
                                // json type으로 parsing
                                console.log("res.result : " + res.result)
                                if(res.result == "failure"){
                                    console.log('취소를 실패했습니다.')
                                    return;
                                }
                                // 받아온 data=rows(res)를 갖고, "show_service_from_db"에 table로 출력해줌
                                else if(res.result == "success"){
                                    console.log('취소를 성공했습니다.')
                                    // 해당 row 삭제
                                    show_table_columns.deleteRow(i+1)
                                }
                            })
                        })
                    }
                    








                    
                }
            })
        }


    </script>
    



</body>

</html>